

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/logo.jpg">
  <link rel="icon" href="/img/logo.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#6aa84f">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
    <meta name="description" content="MySQL数据库API库 编写hello应用链接函数库   MySQL API常用函数 总体印象 初始化 Makefile 管理 连接数据库关闭连接 读取数据 示例程序   MySQL tools实现 思路分析 程序实现 中文问题：   预处理类API函数： 日期时间类API函数 多查询执行的C API函数 MySQL中的事务      MySQL数据库API库#访问MySQL服务器，这">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL数据库API库">
<meta property="og:url" content="https://txt1994.github.io/2022/01/05/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93API%E5%BA%93/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="MySQL数据库API库 编写hello应用链接函数库   MySQL API常用函数 总体印象 初始化 Makefile 管理 连接数据库关闭连接 读取数据 示例程序   MySQL tools实现 思路分析 程序实现 中文问题：   预处理类API函数： 日期时间类API函数 多查询执行的C API函数 MySQL中的事务      MySQL数据库API库#访问MySQL服务器，这">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://txt1994.github.io/img/mysql_logo_1.png">
<meta property="article:published_time" content="2022-01-05T12:21:29.000Z">
<meta property="article:modified_time" content="2022-03-18T16:06:18.000Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="DataBase">
<meta property="article:tag" content="Mysql">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://txt1994.github.io/img/mysql_logo_1.png">
  
  
  <title>MySQL数据库API库 - Hexo</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hint.css@2/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->

  
<link rel="stylesheet" href="/css/style.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"txt1994.github.io","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 6.1.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>txt1994s</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友联
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="MySQL数据库API库">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2022-01-05 20:21" pubdate>
        2022年1月5日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      24k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      199 分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">MySQL数据库API库</h1>
            
              <p class="note note-info">
                
                  本文最后更新于：2022年3月19日 凌晨
                
              </p>
            
            <div class="markdown-body">
              <div class="toc">

<!-- toc -->

<ul>
<li><a href="#mysql-shu-ju-ku-api-ku">MySQL数据库API库</a><ul>
<li><a href="#bian-xie-hello-ying-yong-lian-jie-han-shu-ku">编写hello应用链接函数库</a></li>
</ul>
</li>
<li><a href="#mysql-api-chang-yong-han-shu"><strong>MySQL</strong> API常用函数</a><ul>
<li><a href="#zong-ti-yin-xiang">总体印象</a></li>
<li><a href="#chu-shi-hua">初始化</a></li>
<li><a href="#makefile-guan-li">Makefile 管理</a></li>
<li><a href="#lian-jie-shu-ju-ku-guan-bi-lian-jie">连接数据库关闭连接</a></li>
<li><a href="#du-qu-shu-ju">读取数据</a></li>
<li><a href="#shi-li-cheng-xu">示例程序</a></li>
</ul>
</li>
<li><a href="#mysql-tools-shi-xian">MySQL tools实现</a><ul>
<li><a href="#si-lu-fen-xi">思路分析</a></li>
<li><a href="#cheng-xu-shi-xian">程序实现</a></li>
<li><a href="#zhong-wen-wen-ti">中文问题：</a></li>
</ul>
</li>
<li><a href="#yu-chu-li-lei-api-han-shu">预处理类API函数：</a></li>
<li><a href="#ri-qi-shi-jian-lei-api-han-shu">日期时间类API函数</a></li>
<li><a href="#duo-cha-xun-zhi-xing-de-c-api-han-shu">多查询执行的C API函数</a></li>
<li><a href="#mysql-zhong-de-shi-wu">MySQL中的事务</a></li>
</ul>
<!-- tocstop -->

</div>

<h2><span id="mysql-shu-ju-ku-api-ku">MySQL数据库API库</span><a href="#mysql-shu-ju-ku-api-ku" class="header-anchor">#</a></h2><p>访问MySQL服务器，这需要使用mysqlclient库，MySQL的大多数客户端API（除Java和.NET）都是通过这个库来和MySQL服务器通讯的，而这个库正是使用C语言编写的。</p>
<p>可使用mysql -V 命令查看当前系统内所使用的mysql数据库版本信息。数据库版本为5.6.20版。因此，我们可从帮助手册refman-5.6-en.a4.pdf入手，了解学习MySQL C API使用的一般信息。</p>
<p>从API手册23.8中可获取信息，MySQL客户端使用 libmysqlclient 库内部的函数访问MySQL服务器。因此我们在编程过程中，如若使用到库内的函数，必须链接函数库，对应的要找到头文件所在目录位置、函数库路径。以便我们在使用gcc编译工具时可以填充参数-I、-L、-l。</p>
<p>从手册中可获知，函数库名为mysqlclient。</p>
<p>因此我们使用命令:</p>
<div class="code-wrapper"><pre><code class="hljs shell">find / -name libmysqlclient* 查找该库的路径。得到 /usr/lib64/mysql/libmysqlclient.a。</code></pre></div>

<p><code>nm /usr/lib64/mysql/libmysqlclient.a</code>命令可查看库内包含的函数。</p>
<h3><span id="bian-xie-hello-ying-yong-lian-jie-han-shu-ku">编写hello应用链接函数库</span><a href="#bian-xie-hello-ying-yong-lian-jie-han-shu-ku" class="header-anchor">#</a></h3><p>编写一个hello.c应用程序，链接使用该库。          </p>
<p>用到头文件 <code>&lt;mysql.h&gt;</code> 可使用<code>locate mysql.h</code>查看其目录位置<code>/usr/include/mysql/mysql.h</code>。</p>
<p>编译引用了库的应用程序。    </p>
<div class="code-wrapper"><pre><code class="hljs shell">gcc hello.c -o hello -I/usr/include/mysql/ -L/usr/lib64/mysql/ -lmysqlclient</code></pre></div>

<p>参见帮助手册refman-5.6-en.a4.pdf：23.8.4.3小节。</p>
<h2><span id="mysql-api-chang-yong-han-shu"><strong>MySQL</strong>  API常用函数</span><a href="#mysql-api-chang-yong-han-shu" class="header-anchor">#</a></h2><h3><span id="zong-ti-yin-xiang">总体印象</span><a href="#zong-ti-yin-xiang" class="header-anchor">#</a></h3><p>使用MySQL库API函数的一般步骤：</p>
<p>a. 初始化.     <code>MYSQL *mysql_init(MYSQL *mysql);</code></p>
<p>b. 错误处理    <code>unsigned int mysql_errno(MYSQL *mysql);                         char *mysql_error(MYSQL *mysql);</code></p>
<p>c. 建立连接.    <code>MYSQL *mysql_real_connect(MYSQL *mysql, const char *host, const char *user, const char *passwd,const char *db,                             unsigned int port, const char *unix_socket, unsigned long client_flag);</code></p>
<p>d. 执行SQL语句    <code>int mysql_query(MYSQL *mysql, const char *stmt_str);</code></p>
<p>e. 获取结果    <code>MYSQL_RES *mysql_store_result(MYSQL *mysql)</code><br>                        <code>MYSQL_ROW mysql_fetch_row(MYSQL_RES *result);</code></p>
<p>f. 释放内存    <code>void mysql_free_result(MYSQL_RES *result);</code></p>
<p>g. 关闭连接    <code>void mysql_close(MYSQL *mysql);</code></p>
<h3><span id="chu-shi-hua">初始化</span><a href="#chu-shi-hua" class="header-anchor">#</a></h3><p>编写程序测试 初始化函数<code>MYSQL *mysql_init(MYSQL *mysql)</code>。</p>
<p>其中有一种新数据类型MYSQL。可在头文件mysql.h → 263. typedef struct st_mysql {…} MYSQL;找到其定义。是一个结构体。</p>
<div class="code-wrapper"><pre><code class="hljs">处理错误码的函数：unsigned int mysql_errno(MYSQL *mysql) 
</code></pre></div>
<div class="code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"mysql.h"</span></span>

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
	<span class="hljs-type">int</span> i, ret = <span class="hljs-number">0</span>, num = <span class="hljs-number">0</span>;

	MYSQL *mysql = mysql_init(<span class="hljs-literal">NULL</span>);
	<span class="hljs-keyword">if</span> (mysql == <span class="hljs-literal">NULL</span>) {
	
	ret = mysql_errno(mysql);
	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"mysql_init err:%d\n"</span>, ret);
	
	<span class="hljs-keyword">return</span> ret;
	}
	
	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"init ok...\n"</span>);
	
	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}</code></pre></div>

<blockquote>
<p>编译出错，原因是64位Linux环境下，动态库配置不完整。<br>需手动指定编译所用的动态库。根据错误提示分析需要加入如下函数库：</p>
</blockquote>
<ol>
<li><p>__gxx_personality_v0        –&gt;     -lstdc++        使用g++相关的环境</p>
</li>
<li><p>dlclose/dlopen/dlsym          –&gt;    -ldl            完成用一个程序加载其他动态库的作用。</p>
</li>
<li><p>pthread_*                            –&gt;  -lpthread        线程库</p>
</li>
<li><p><code>my_getsystime'/</code>clock_gettime’    –&gt;  -lrt            librt.so是glibc中对real-time的支持库</p>
</li>
</ol>
<p>使用<code>ldd</code>命令可以查看该可执行文件运行所依赖的库文件。</p>
<h3><span id="makefile-guan-li">Makefile 管理</span><a href="#makefile-guan-li" class="header-anchor">#</a></h3><div class="code-wrapper"><pre><code class="hljs makefile">src = <span class="hljs-variable">$(<span class="hljs-built_in">wildcard</span> *.c)</span>

target = <span class="hljs-variable">$(<span class="hljs-built_in">patsubst</span> %.c, %, <span class="hljs-variable">$(src)</span>)</span>

inc_path = /usr/<span class="hljs-keyword">include</span>/mysql/

lib_path = /usr/lib64/mysql/

<span class="hljs-section">all: <span class="hljs-variable">$(target)</span></span>

<span class="hljs-section">%:%.c</span>

	gcc <span class="hljs-variable">$&lt;</span> -o <span class="hljs-variable">$@</span> -I<span class="hljs-variable">$(inc_path)</span> -L<span class="hljs-variable">$(lib_path)</span> -lmysqlclient -lstdc++ -lpthread -ldl -lrt

<span class="hljs-section">clean:</span>

	-rm -rf <span class="hljs-variable">$(target)</span>

<span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>: all clean</span></code></pre></div>

<p>注意：在测试makefile时，应先使用-n参数，检查无误再执行。</p>
<h3><span id="lian-jie-shu-ju-ku-guan-bi-lian-jie">连接数据库关闭连接</span><a href="#lian-jie-shu-ju-ku-guan-bi-lian-jie" class="header-anchor">#</a></h3><div class="code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">// 依据proc猜想应该是一个类似于connect的函数，查看API文档发现：mysql_connect();但该函数已经过时，应该使用手册中推荐的mysql_real_connect函数取而代之。</span>

MYSQL *<span class="hljs-title function_">mysql_real_connect</span><span class="hljs-params">(MYSQL *mysql, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *host, </span>
<span class="hljs-params">                          <span class="hljs-type">const</span> <span class="hljs-type">char</span> *user, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *passwd, </span>
<span class="hljs-params">                          <span class="hljs-type">const</span> <span class="hljs-type">char</span> *db, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> port, </span>
<span class="hljs-params">                          <span class="hljs-type">const</span> <span class="hljs-type">char</span> *unix_socket, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> client_flag</span>
<span class="hljs-params">                         )</span>;

<span class="hljs-comment">// 根据手册中的描述，我们可以使用基础的链接方式与MySQL数据库建立连接。</span>

mysql = mysql_real_connect(mysql, <span class="hljs-string">"localhost"</span>, <span class="hljs-string">"root"</span>, 
                           <span class="hljs-string">"123456"</span>, <span class="hljs-string">"mydb61"</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>
                          );

<span class="hljs-comment">//  连接数据库成功。对表中数据进行访问，</span>
<span class="hljs-comment">//		访问结束需调用void mysql_close(MYSQL *mysql) 函数关闭连接。</span>
<span class="hljs-comment">//  	该函数在断开连接的同时，还可以解除分配由mysql指向的连接句柄。</span>

mysql_close(mysql);</code></pre></div>

<h3><span id="du-qu-shu-ju">读取数据</span><a href="#du-qu-shu-ju" class="header-anchor">#</a></h3><h4><span id="cha-xun-biao-shu-ju">查询表数据</span><a href="#cha-xun-biao-shu-ju" class="header-anchor">#</a></h4><div class="code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">// mysql_query函数不单单能完成查询sql的功能，还能完成非select语句在c程序中的执行。</span>
<span class="hljs-comment">// 		是一个十分万能的c程序中执行SQL语句的函数。并且该函数本身直接支持静态SQL。查询以\0结尾的字符串。</span>
<span class="hljs-comment">// 		如果语句中包含二进制数据，则需要调用mysql_real_query来执行查询语句。</span>

<span class="hljs-comment">// 函数原型：int mysql_query(MYSQL *mysql, const char *query);	</span>
<span class="hljs-comment">//		成功返回0，失败返回非0</span>

<span class="hljs-type">char</span> *psql = <span class="hljs-string">"select * from emp"</span>;

ret = mysql_query(mysql, psql);</code></pre></div>

<p>若执行的是<code>UPDATE</code>, <code>DELETE</code>或<code>INSERT</code>语句，则可通过<code>mysql_affected_rows()</code>获知受影响的记录数。</p>
<p>若执行的是<code>SELECT</code>语句，查询结束后，查询结果被保存在<code>mysql句柄</code>中。需要使用获取结果集的API函数将结果集获取出来。有两种方式可以获取结果集。</p>
<p>注意: <code>mysql_query</code>执行的SQL语句不应为语句添加终结分号（‘;’）或“\g”。</p>
<h4><span id="huo-qu-jie-guo-ji">获取结果集</span><a href="#huo-qu-jie-guo-ji" class="header-anchor">#</a></h4><p>一种方式是通过<code>mysql_store_result()</code>将整个结果集全部取回来。另一种方式则是调用<code>mysql_use_result()</code>初始化获取操作，但暂时不取回任何记录。视结果集的条目数选择获取结果集的函数。两种方法均通过<code>mysql_fetch_row()</code>来访问每一条记录。</p>
<div class="code-wrapper"><pre><code class="hljs c">MYSQL_RES *<span class="hljs-title function_">mysql_store_result</span><span class="hljs-params">(MYSQL *mysql)</span> <span class="hljs-comment">// 成功返回MYSQL_RES结果集指针，失败返回NULL。</span>

<span class="hljs-comment">// MYSQL_RES是一个结构体类型，可以从mysql.h头文件中找到该结构体的定义：</span>

mysql.h → 308. <span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> st_mysql_res {...} MYSQL_RES;</code></pre></div>

<p>整体获取的结果集，保存在 <code>MYSQL_RES</code> 结构体指针中，通过检查<code>mysql_store_result()</code>是否返回<code>NULL</code>，可检测函数执行是否成功：</p>
<div class="code-wrapper"><pre><code class="hljs c">MYSQL_RES *result = mysql_store_result(mysql);
<span class="hljs-keyword">if</span> (result == <span class="hljs-literal">NULL</span>) {
    ret = mysql_errno(mysql);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"mysql_store_result error: %s\n"</span>, mysql_error(mysql));

    <span class="hljs-keyword">return</span> ret;	
}</code></pre></div>
<p>该函数调用成功，则SQL查询的结果被保存在result中，但我们不清楚有多少条数据。所以应使用游标的方式将结果集中的数据逐条取出。</p>
<h4><span id="jie-xi-jie-guo-ji">解析结果集</span><a href="#jie-xi-jie-guo-ji" class="header-anchor">#</a></h4><p>通过游标一行一行fetch结果集中的数据。根据游标使用的一般特性，应使用循环结构，到达结尾或者出错，返回NULL。</p>
<div class="code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">// 函数原型：MYSQL_ROW mysql_fetch_row(MYSQL_RES *result) 成功返回下一行的MYSQL_ROW结构。</span>
<span class="hljs-comment">// 		如果没有更多要检索的行或出现了错误，返回NULL。-----MYSQL_ROW定义在118行</span>

select * from emp  <span class="hljs-comment">// 可以看到emp表一共有8列数据。可以循环将每行上每一列的数据显示到屏幕。</span>

MYSQL_ROW row = <span class="hljs-literal">NULL</span>;				<span class="hljs-comment">//typedef char **MYSQL_ROW;	</span>

<span class="hljs-keyword">while</span> ((row = mysql_fetch_row(result))) {

<span class="hljs-built_in">printf</span>(<span class="hljs-string">"%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\n"</span>, row[<span class="hljs-number">0</span>],row[<span class="hljs-number">1</span>],row[<span class="hljs-number">2</span>],row[<span class="hljs-number">3</span>],row[<span class="hljs-number">4</span>],row[<span class="hljs-number">5</span>],row[<span class="hljs-number">6</span>],row[<span class="hljs-number">7</span>]);

}</code></pre></div>

<p>MYSQL_ROW的本质是 typedef char ** MYSQL_ROW; 数据信息存储的形式如下图所示：</p>
<p><img src="https://gitee.com/txt1994/images/raw/master/img/mysql/wps1.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>从<code>mysql.h</code>头文件可查看MYSQL_ROW定义: 118. typedef char **MYSQL_ROW; /<em>return data as array of string</em>/</p>
<div class="code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">// 从上图分析MYSQL_ROW为什么被定义为char**类型呢？推测mysq_fetch_row()的函数实现大致思想如下：</span>

<span class="hljs-type">char</span> **<span class="hljs-title function_">mysql_fetch_row</span><span class="hljs-params">()</span>{
    <span class="hljs-type">char</span> **tmp = (<span class="hljs-type">char</span> **) <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">char</span> *) * <span class="hljs-number">8</span>);

    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; i++) {
        tmp[i] = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">50</span>);
    }

    <span class="hljs-built_in">strcpy</span>(tmp[<span class="hljs-number">0</span>], <span class="hljs-string">"7369"</span>);

    <span class="hljs-built_in">strcpy</span>(tmp[<span class="hljs-number">1</span>], <span class="hljs-string">"SMITH"</span>);

    <span class="hljs-built_in">strcpy</span>(tmp[<span class="hljs-number">2</span>], <span class="hljs-string">"CLERK"</span>);

    ...

    <span class="hljs-keyword">return</span> tmp;
}</code></pre></div>

<h4><span id="shi-fang-jie-guo-ji">释放结果集</span><a href="#shi-fang-jie-guo-ji" class="header-anchor">#</a></h4><blockquote>
<p>结果集处理完成，应调用对应的函数释放所占用的内存。        </p>
</blockquote>
<p><code>void mysql_free_result(MYSQL_RES *result)</code>; 成功释放参数传递的结果集。没有失败情况。</p>
<div class="code-wrapper"><pre><code class="hljs c">mysql_free_result(result);</code></pre></div>

<p>思考：上述实现是直接在MySQL工具中数出列数。找寻能获取列数的API函数、获取表头的API函数。</p>
<h4><span id="huo-qu-lie-shu">获取列数</span><a href="#huo-qu-lie-shu" class="header-anchor">#</a></h4><div class="code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">// 查看帮助手册可以看到，有两个函数具备获取列数的功能：</span>

<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title function_">mysql_field_count</span><span class="hljs-params">(MYSQL *mysql)</span> 			<span class="hljs-comment">// 从mysql句柄中获取有多少列。</span>

<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title function_">mysql_num_fields</span><span class="hljs-params">(MYSQL_RES *result)</span> 		<span class="hljs-comment">// 从返回的结果集中获取有多少列。</span>

<span class="hljs-comment">// 选择任意一种方式均可以完成该功能。</span>

<span class="hljs-type">int</span> num = mysql_field_count(connect); 
<span class="hljs-keyword">while</span> (row = mysql_fetch_row(result)) {
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; num; i++) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%s\t"</span>, row[i]);
}
<span class="hljs-built_in">printf</span>(<span class="hljs-string">"\n"</span>);

<span class="hljs-comment">//printf("%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\n", row[0],row[1],row[2],row[3],row[4],row[5],row[6],row[7]);</span></code></pre></div>

<h4><span id="huo-qu-biao-tou">获取表头</span><a href="#huo-qu-biao-tou" class="header-anchor">#</a></h4><div class="code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">// 获取表头的API函数同样有两个：</span>

MYSQL_FIELD *<span class="hljs-title function_">mysql_fetch_fields</span><span class="hljs-params">(MYSQL_RES *result)</span> 	<span class="hljs-comment">// 全部获取</span>

MYSQL_FIELD *<span class="hljs-title function_">mysql_fetch_field</span><span class="hljs-params">(MYSQL_RES *result)</span> 	<span class="hljs-comment">// 获取单个</span>

<span class="hljs-comment">// MYSQL_FIELD也是一个结构体类型，其内部保存了选择列表项的信息，</span>
<span class="hljs-comment">// 		其中的name成员变量就保存着列名。可从头文件mysql.h中94-116行找到其定义。</span>

MYSQL_FIELD *fields = <span class="hljs-literal">NULL</span>;
fields = mysql_fetch_fields(result);	<span class="hljs-comment">//得到表头的结构体数组</span>
<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; num; i++) {				<span class="hljs-comment">//已通过 mysql_field_count	获取了总列数	</span>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%s\t"</span>, fields[i].name);		<span class="hljs-comment">//每一列的列名保存在name成员中 </span>
}

<span class="hljs-built_in">printf</span>(<span class="hljs-string">"\n"</span>);</code></pre></div>

<h3><span id="shi-li-cheng-xu">示例程序</span><a href="#shi-li-cheng-xu" class="header-anchor">#</a></h3><div class="code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"mysql.h"</span> </span>

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
    <span class="hljs-type">int</span> i, ret = <span class="hljs-number">0</span>, num = <span class="hljs-number">0</span>;

    <span class="hljs-type">char</span> *psql = <span class="hljs-string">"select * from emp"</span>;			 

    MYSQL_RES *result = <span class="hljs-literal">NULL</span>;

    MYSQL_FIELD *fields = <span class="hljs-literal">NULL</span>;

    MYSQL_ROW row = <span class="hljs-literal">NULL</span>;						

    MYSQL *mysql = mysql_init(<span class="hljs-literal">NULL</span>);
    <span class="hljs-keyword">if</span> (mysql == <span class="hljs-literal">NULL</span>) {
        ret = mysql_errno(mysql);
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"mysql_init err:%d\n"</span>, ret);
        <span class="hljs-keyword">return</span> ret;
    }

    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"init ok...\n"</span>);

    mysql = mysql_real_connect(mysql, <span class="hljs-string">"localhost"</span>, <span class="hljs-string">"root"</span>, <span class="hljs-string">"123456"</span>, <span class="hljs-string">"mydb61"</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">if</span> (mysql == <span class="hljs-literal">NULL</span>) {
        ret = mysql_errno(mysql);
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"mysql_init err:%d\n"</span>, ret);
        <span class="hljs-keyword">return</span> ret;
    }

    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"connect ok...\n"</span>);

    ret = mysql_query(mysql, psql);
    <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"mysql_query error: %s\n"</span>, mysql_error(mysql));
        <span class="hljs-keyword">return</span> ret;	
    }

    num = mysql_field_count(mysql);
    
    result = mysql_store_result(mysql);
    <span class="hljs-keyword">if</span> (result == <span class="hljs-literal">NULL</span>) {
        ret = mysql_errno(mysql);
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"mysql_store_result error: %s\n"</span>, mysql_error(mysql));
        <span class="hljs-keyword">return</span> ret;	
    }

    fields = mysql_fetch_fields(result);
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; num; i++) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%10s\t"</span>, fields[i].name);
    }

    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\n"</span>);

    <span class="hljs-keyword">while</span> ((row = mysql_fetch_row(result))) {
        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; num; i++) {
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%10s\t"</span>, row[i]);	
        }
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\n"</span>);
    }

    mysql_free_result(result);

    mysql_close(mysql);

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;	
}</code></pre></div>

<h2><span id="mysql-tools-shi-xian">MySQL tools实现</span><a href="#mysql-tools-shi-xian" class="header-anchor">#</a></h2><p>依托我们所学习的MySQL基础类API函数，可以编写程序实现简单的<code>sqlplus/mysql</code> 工具的功能。</p>
<h3><span id="si-lu-fen-xi">思路分析</span><a href="#si-lu-fen-xi" class="header-anchor">#</a></h3><p>\1. 仿照mysql工具，应在连接数据库成功之后，在一个while循环中不断的接受用户输入的SQL语句。定义char sqlbuf[1024] 存储用户输入的SQL语句。初始化该buf，并提示用户输入SQL语句。使用gets函数在循环中动态接收用户输入。</p>
<div class="code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {
    <span class="hljs-built_in">memset</span>(sqlbuf, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(sqlbuf));

    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\nYourSQL&gt; "</span>);

    fgets(sqlbuf, <span class="hljs-keyword">sizeof</span>(sqlbuf), <span class="hljs-built_in">stdin</span>);
}</code></pre></div>

<ol start="2">
<li><p>在mysql_query(connect, sqlbuf)之前，如果用户输入了“exit”那么程序直接结束。</p>
</li>
<li><p>在执行完 mysql_query(connect, sqlbuf)之后，应该判别用户输入的是否为select语句。如不是select语句不需要查询结果集、处理结果集等繁复操作。</p>
</li>
<li><p>如用户输入的是有结果集的SQL语句，将获取列数、获取结果集、获取表头、解析结果集、释放结果集等相关代码一起并入<code>if (strncmp(sqlbuf, "select", 6))</code>中。</p>
</li>
</ol>
<blockquote>
<p>测试注意：执行SQL语句时不要在结尾加“;”            </p>
</blockquote>
<h3><span id="cheng-xu-shi-xian">程序实现</span><a href="#cheng-xu-shi-xian" class="header-anchor">#</a></h3><div class="code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"mysql.h"</span> </span>

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{ 
    <span class="hljs-type">int</span> i, ret = <span class="hljs-number">0</span>, num = <span class="hljs-number">0</span>;

    <span class="hljs-comment">//char *psql = "select * from emp";			 </span>

    <span class="hljs-type">char</span> sqlbuf[<span class="hljs-number">1024</span>]; 

    MYSQL *mysql = mysql_init(<span class="hljs-literal">NULL</span>);
    <span class="hljs-keyword">if</span> (mysql == <span class="hljs-literal">NULL</span>) {
        ret = mysql_errno(mysql);
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"mysql_init err:%d\n"</span>, ret);
        <span class="hljs-keyword">return</span> ret;
    }

    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"init ok...\n"</span>); 

    mysql = mysql_real_connect(mysql, <span class="hljs-string">"localhost"</span>, <span class="hljs-string">"root"</span>, <span class="hljs-string">"123456"</span>, <span class="hljs-string">"mydb61"</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">if</span> (mysql == <span class="hljs-literal">NULL</span>) {
        ret = mysql_errno(mysql);
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"mysql_init err:%d\n"</span>, ret);
        <span class="hljs-keyword">return</span> ret;
    }

    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"connect ok...\n"</span>);

    ret = mysql_query(mysql, <span class="hljs-string">"set names utf8"</span>); 
    <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"mysql_query error: %s\n"</span>, mysql_error(mysql));
        <span class="hljs-keyword">return</span> ret;	
    }

    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {		
        <span class="hljs-built_in">memset</span>(sqlbuf, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(sqlbuf));

        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"YourSQL&gt; "</span>);

        fgets(sqlbuf, <span class="hljs-keyword">sizeof</span>(sqlbuf), <span class="hljs-built_in">stdin</span>);	
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strncmp</span>(sqlbuf, <span class="hljs-string">"exit"</span>, <span class="hljs-number">4</span>) || <span class="hljs-built_in">strncmp</span>(sqlbuf, <span class="hljs-string">"quit"</span>, <span class="hljs-number">4</span>) ) {
            <span class="hljs-keyword">break</span>;
        }

        ret = mysql_query(mysql, sqlbuf);
        <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) {
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"mysql_query error: %s\n"</span>, mysql_error(mysql));

            <span class="hljs-keyword">return</span> ret;	
        }

        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strncmp</span>(sqlbuf, <span class="hljs-string">"select"</span>, <span class="hljs-number">6</span>) || <span class="hljs-built_in">strncmp</span>(sqlbuf, <span class="hljs-string">"SELECT"</span>, <span class="hljs-number">6</span>)) {
            num = mysql_field_count(mysql);	
            MYSQL_RES *result = <span class="hljs-literal">NULL</span>;

            result = mysql_store_result(mysql);
            <span class="hljs-keyword">if</span> (result == <span class="hljs-literal">NULL</span>) {
                ret = mysql_errno(mysql);
                <span class="hljs-built_in">printf</span>(<span class="hljs-string">"mysql_store_result error: %s\n"</span>, mysql_error(mysql));
                <span class="hljs-keyword">return</span> ret;	
            }

            <span class="hljs-comment">//打印表头 </span>
            MYSQL_FIELD *fields = <span class="hljs-literal">NULL</span>;
            fields = mysql_fetch_fields(result);
            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; num; i++) {
                <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%10s\t"</span>, fields[i].name);
            }

            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\n"</span>);	

            <span class="hljs-comment">//解析结果集</span>

            MYSQL_ROW row = <span class="hljs-literal">NULL</span>;		<span class="hljs-comment">//typedef char **MYSQL_ROW;	</span>
            <span class="hljs-keyword">while</span> ((row = mysql_fetch_row(result))) {
                <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; num; i++) {
                    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%10s\t"</span>, row[i]);	
                }
                <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\n"</span>);
            }			

            mysql_free_result(result);			
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\n--- not select sql---\n"</span>);
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"affected: %ld\n"</span>, (<span class="hljs-type">long</span>)mysql_affected_rows(mysql));
        }
    }

    mysql_close(mysql);

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;	
}</code></pre></div>

<h3><span id="zhong-wen-wen-ti">中文问题：</span><a href="#zhong-wen-wen-ti" class="header-anchor">#</a></h3><p>修改<code>mysql_real_connect()</code>参数，连接到表中有中文数据的数据库，如mydb2，执行程序，测试显示中文出现乱码。我们可以使用<code>mysql_query</code>函数来解决该问题。</p>
<p>在 while (1) 之前使用 <code>ret = mysql_query(mysql, "set names utf8")</code>; 来设置查询属性(也可以加到while中)。表示在查询的时候使用utf8的形式进行查询。</p>
<p>或者<code>mysql_set_character_set(mysql, "utf8")</code>;</p>
<p>获取当前使用的字符集:  <code>const char *mysql_character_set_name(MYSQL *mysql)</code></p>
<h2><span id="yu-chu-li-lei-api-han-shu">预处理类API函数：</span><a href="#yu-chu-li-lei-api-han-shu" class="header-anchor">#</a></h2><p>该类函数解决问题：处理带有占位符的SQL语句。<code>insert into table111(col1, col2, col3) values(?, ?, ?)</code>;    </p>
<p>这种SQL语句由两部分组成，一部分是SQL语句体模型部分，另一部分是？所匹配的值。    </p>
<p>性能、调优是数据库编程永恒不变的主题！如果能把SQL语句框架预先处理好，当真正要执行SQL语句时只需要发送对应的参数到对应的SQL框架中，就能提高客户端访问服务器的速度，且数据量小，可以减少网络通信量，提高数据传输效率高。                </p>
<p>元数据（Metadata）：又称中介数据、中继数据，为描述数据的数据，主要是描述数据属性的信息，用来支持如指示存储位置、历史数据、资源查找、文件记录等功能。</p>
<p>根据API提供的案例学习该部分内容。主要有 4 个函数：    </p>
<p><code>mysql_stmt_init()</code>                初始化预处理环境句柄。    返回一个结构体指针 MYSQL_STMT *stmt</p>
<p><code>mysql_stmt_prepare()</code>            向上面句柄中添加SQL语句，带有 (?,?,?) 占位符</p>
<p><code>mysql_stmt_param_count()</code>     求绑定变量的个数(辅助函数)， 有多少个’?’就返回多少</p>
<p><code>mysql_stmt_bind_param()</code>        将?对应的实参，设置到预处理环境句柄中</p>
<p><code>mysql_stmt_execute()</code>            执行预处理的SQL语句</p>
<p><img src="https://gitee.com/txt1994/images/raw/master/img/mysql/wps2.jpg" srcset="/img/loading.gif" lazyload alt="img"> </p>
<blockquote>
<p>在不熟悉这套API函数的情况下，如何能快速的找到一个完整的案例，使用这套函数呢？分析：在以上4个过程中，哪个最重要呢？找到它，去查看API文档！发现有对应的demo程序。将该demo导入到我们的程序中，运行，观察它的作用。</p>
</blockquote>
<div class="code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"mysql.h"</span> </span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> STRING_SIZE 50 </span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> DROP_SAMPLE_TABLE <span class="hljs-string">"DROP TABLE IF EXISTS test_table"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> CREATE_SAMPLE_TABLE <span class="hljs-string">"CREATE TABLE test_table(col1 INT,\</span></span>
<span class="hljs-string"><span class="hljs-meta">                         col2 VARCHAR(40),\</span></span>
<span class="hljs-string"><span class="hljs-meta">                         col3 SMALLINT,\</span></span>
<span class="hljs-string"><span class="hljs-meta">                         col4 TIMESTAMP)"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> INSERT_SAMPLE <span class="hljs-string">"INSERT INTO test_table(col1,col2,col3) VALUES(?,?,?)"</span> </span>

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{ 
	<span class="hljs-type">int</span> ret = <span class="hljs-number">0</span>;

	MYSQL *mysql = mysql_init(<span class="hljs-literal">NULL</span>);
	
	<span class="hljs-keyword">if</span> (mysql == <span class="hljs-literal">NULL</span>) {
		<span class="hljs-comment">//unsigned int mysql_errno(MYSQL *mysql) 	</span>
		ret = mysql_errno(mysql);
		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"mysql_init err:%d\n"</span>, ret);

		<span class="hljs-keyword">return</span> ret;
	}
	
	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"init ok...\n"</span>); 
	
	mysql = mysql_real_connect(mysql, <span class="hljs-string">"localhost"</span>, <span class="hljs-string">"root"</span>, <span class="hljs-string">"123456"</span>, <span class="hljs-string">"mydb61"</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);
	<span class="hljs-keyword">if</span> (mysql == <span class="hljs-literal">NULL</span>) {
		ret = mysql_errno(mysql);
		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"mysql_init err:%d\n"</span>, ret);
	
		<span class="hljs-keyword">return</span> ret;
	}
	
	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"connect ok...\n"</span>);

<span class="hljs-comment">////////////////////////以下为demo源码//////////////////////////////// </span>
	MYSQL_STMT   *stmt;
	
	MYSQL_BIND   bind[<span class="hljs-number">3</span>];
	
	my_ulonglong  affected_rows;
	
	<span class="hljs-type">int</span>      param_count;
	
	<span class="hljs-type">short</span>     small_data;
	
	<span class="hljs-type">int</span>      int_data;
	
	<span class="hljs-type">char</span>      str_data[STRING_SIZE];
	
	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> str_length;
	
	my_bool    is_null; 
	
	<span class="hljs-keyword">if</span> (mysql_query(mysql, DROP_SAMPLE_TABLE))
	{
		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">" DROP TABLE failed\n"</span>);
		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">" %s\n"</span>, mysql_error(mysql));
		<span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);
	} 
	
	<span class="hljs-keyword">if</span> (mysql_query(mysql, CREATE_SAMPLE_TABLE))
	{
		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">" CREATE TABLE failed\n"</span>);
		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">" %s\n"</span>, mysql_error(mysql));
		<span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);
	}
	
	<span class="hljs-comment">/* Prepare an INSERT query with 3 parameters */</span>
	
	<span class="hljs-comment">/* (the TIMESTAMP column is not named; the server */</span>
	
	<span class="hljs-comment">/*  sets it to the current date and time) */</span>
	
	stmt = mysql_stmt_init(mysql);
	<span class="hljs-keyword">if</span> (!stmt)
	{
		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">" mysql_stmt_init(), out of memory\n"</span>);
		<span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);
	}
	
	<span class="hljs-keyword">if</span> (mysql_stmt_prepare(stmt, INSERT_SAMPLE, <span class="hljs-built_in">strlen</span>(INSERT_SAMPLE)))
	{
		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">" mysql_stmt_prepare(), INSERT failed\n"</span>);
		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">" %s\n"</span>, mysql_stmt_error(stmt));
		<span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);
	}
	
	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stdout</span>, <span class="hljs-string">" prepare, INSERT successful\n"</span>); 
	
	<span class="hljs-comment">/* Get the parameter count from the statement */</span>
	
	param_count= mysql_stmt_param_count(stmt);
	
	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stdout</span>, <span class="hljs-string">" total parameters in INSERT: %d\n"</span>, param_count);
	<span class="hljs-keyword">if</span> (param_count != <span class="hljs-number">3</span>) <span class="hljs-comment">/* validate parameter count */</span>
	{
		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">" invalid parameter count returned by MySQL\n"</span>);
		<span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);
	}

    <span class="hljs-comment">/* Bind the data for all 3 parameters */</span>
	<span class="hljs-built_in">memset</span>(bind, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(bind));

	<span class="hljs-comment">/* INTEGER PARAM */</span>

	<span class="hljs-comment">/* This is a number type, so there is no need to specify buffer_length */</span>

	bind[<span class="hljs-number">0</span>].buffer_type = MYSQL_TYPE_LONG;
	
	bind[<span class="hljs-number">0</span>].buffer = (<span class="hljs-type">char</span> *)&amp;int_data;
	
	bind[<span class="hljs-number">0</span>].is_null = <span class="hljs-number">0</span>;
	
	bind[<span class="hljs-number">0</span>].length = <span class="hljs-number">0</span>;

	<span class="hljs-comment">/* STRING PARAM */</span>
	
	bind[<span class="hljs-number">1</span>].buffer_type = MYSQL_TYPE_STRING;
	
	bind[<span class="hljs-number">1</span>].buffer = (<span class="hljs-type">char</span> *)str_data;
	
	bind[<span class="hljs-number">1</span>].buffer_length = STRING_SIZE;
	
	bind[<span class="hljs-number">1</span>].is_null = <span class="hljs-number">0</span>;
	
	bind[<span class="hljs-number">1</span>].length = &amp;str_length;

	<span class="hljs-comment">/* SMALLINT PARAM */</span>
	
	bind[<span class="hljs-number">2</span>].buffer_type = MYSQL_TYPE_SHORT;
	
	bind[<span class="hljs-number">2</span>].buffer = (<span class="hljs-type">char</span> *)&amp;small_data;
	
	bind[<span class="hljs-number">2</span>].is_null = &amp;is_null;
	
	bind[<span class="hljs-number">2</span>].length = <span class="hljs-number">0</span>;

	<span class="hljs-comment">/* Bind the buffers */</span>
	
	<span class="hljs-keyword">if</span> (mysql_stmt_bind_param(stmt, bind))
	{
		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">" mysql_stmt_bind_param() failed\n"</span>);
	
		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">" %s\n"</span>, mysql_stmt_error(stmt));
		<span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);
	}	
	
	<span class="hljs-comment">/* Specify the data values for the first row */</span>
	int_data= <span class="hljs-number">10</span>;       <span class="hljs-comment">/* integer */</span>
	
	<span class="hljs-built_in">strncpy</span>(str_data, <span class="hljs-string">"MySQL"</span>, STRING_SIZE); <span class="hljs-comment">/* string  */</span>
	
	str_length= <span class="hljs-built_in">strlen</span>(str_data);

	<span class="hljs-comment">/* INSERT SMALLINT data as NULL */</span>
	
	is_null= <span class="hljs-number">1</span>;

	<span class="hljs-comment">/* Execute the INSERT statement - 1*/</span>
	
	<span class="hljs-keyword">if</span> (mysql_stmt_execute(stmt))
	{
		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">" mysql_stmt_execute(), 1 failed\n"</span>);
		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">" %s\n"</span>, mysql_stmt_error(stmt));
		<span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);
	}

	<span class="hljs-comment">/* Get the total number of affected rows */</span>
	
	affected_rows= mysql_stmt_affected_rows(stmt);
	
	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stdout</span>, <span class="hljs-string">" total affected rows(insert 1): %lu\n"</span>,
	      (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) affected_rows);

	<span class="hljs-keyword">if</span> (affected_rows != <span class="hljs-number">1</span>) <span class="hljs-comment">/* validate affected rows */</span>
	{
		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">" invalid affected rows by MySQL\n"</span>);
		<span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);
	}

	<span class="hljs-comment">/* Specify data values for second row, then re-execute the statement */</span>

	int_data= <span class="hljs-number">1000</span>;
	
	<span class="hljs-built_in">strncpy</span>(str_data, <span class="hljs-string">"The most popular Open Source database"</span>, STRING_SIZE);
	
	str_length= <span class="hljs-built_in">strlen</span>(str_data);
	
	small_data= <span class="hljs-number">1000</span>;     <span class="hljs-comment">/* smallint */</span>
	
	is_null= <span class="hljs-number">0</span>;        <span class="hljs-comment">/* reset */</span>

	<span class="hljs-comment">/* Execute the INSERT statement - 2*/</span>
	
	<span class="hljs-keyword">if</span> (mysql_stmt_execute(stmt))
	{
		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">" mysql_stmt_execute, 2 failed\n"</span>);
		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">" %s\n"</span>, mysql_stmt_error(stmt));	
		<span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);
	}

	<span class="hljs-comment">/* Get the total rows affected */</span>
	
	affected_rows= mysql_stmt_affected_rows(stmt);
	
	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stdout</span>, <span class="hljs-string">" total affected rows(insert 2): %lu\n"</span>,
	      (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) affected_rows);

    <span class="hljs-keyword">if</span> (affected_rows != <span class="hljs-number">1</span>) <span class="hljs-comment">/* validate affected rows */</span>
	{
		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">" invalid affected rows by MySQL\n"</span>);
		<span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);
	}

	<span class="hljs-comment">/* Close the statement */</span>
	
	<span class="hljs-keyword">if</span> (mysql_stmt_close(stmt))
	{
		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">" failed while closing the statement\n"</span>);
		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">" %s\n"</span>, mysql_stmt_error(stmt));
		<span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);
	}
	
	mysql_close(mysql);

	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"hello mysql...\n"</span>);

	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;	
}</code></pre></div>

<p>注意：bind –&gt; mysql.h下 MYSQL_BIND结构体  bind[3]; 是一个结构体数组。有3个‘?’占位符，所以用三个结构体(数组)来对应保存信息。0-&gt;第一列；1-&gt;第二列；2-&gt;第三列。</p>
<p><code>mysql.h</code>中查找 <code>MYSQL_BIND</code> 结构体原型。对比：<code>select * from teat_table</code>;  和 <code>desc test_table</code>; 的查询结果。</p>
<p>帮助理解bind的小程序框架：            </p>
<div class="code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">xxx</span>{</span>

    <span class="hljs-type">char</span> *p1;

    <span class="hljs-type">char</span> *p2;

    <span class="hljs-type">char</span> *p3;

} MYSQL_BIND;

<span class="hljs-type">void</span> <span class="hljs-title function_">saveXXXInfo</span><span class="hljs-params">(MYSQL_BIND *bind, <span class="hljs-type">int</span> num)</span>
{
    insert into test_table <span class="hljs-title function_">valudes</span><span class="hljs-params">(bind[<span class="hljs-number">0</span>].p2, bind[<span class="hljs-number">1</span>].p3, bind[<span class="hljs-number">2</span>].p1)</span>;
}

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{

    MYSQL_BIND bind[<span class="hljs-number">3</span>];

    bind[<span class="hljs-number">0</span>].p1 = <span class="hljs-string">"类型1"</span>;		<span class="hljs-comment">//第一列</span>

    bind[<span class="hljs-number">0</span>].p2 = <span class="hljs-string">"10"</span>;

    bind[<span class="hljs-number">0</span>].p3 = <span class="hljs-string">"其他数据"</span>;

    bind[<span class="hljs-number">1</span>].p1 = <span class="hljs-string">"类型"</span>;		<span class="hljs-comment">//第二列</span>

    bind[<span class="hljs-number">1</span>].p2 = <span class="hljs-string">"数据"</span>;

    bind[<span class="hljs-number">1</span>].p3 = <span class="hljs-string">"描述"</span>;

    bind[<span class="hljs-number">2</span>].p1 = <span class="hljs-string">"p1p1p1"</span>;		<span class="hljs-comment">//第三列   </span>

    <span class="hljs-comment">//第四列是时间戳，不需要用户使用?来指定，直接使用了系统时间。</span>

    bind[<span class="hljs-number">2</span>].p2 = <span class="hljs-string">"数据"</span>;

    bind[<span class="hljs-number">2</span>].p3 = <span class="hljs-string">"其他限定条件"</span>;		

    saveXXXInfo(bind, <span class="hljs-number">3</span>);

}</code></pre></div>
<h2><span id="ri-qi-shi-jian-lei-api-han-shu">日期时间类API函数</span><a href="#ri-qi-shi-jian-lei-api-han-shu" class="header-anchor">#</a></h2><p>练习：熟悉上述预处理类工作模式，模拟精简一个将时间插入数据库的程序。将时间存入数据库有两种方式：        </p>
<ol>
<li><p>使用SQL语句方式</p>
</li>
<li><p>预处理环境句柄变量方式存入</p>
</li>
</ol>
<p>提示：</p>
<div class="code-wrapper"><pre><code class="hljs c">MYSQL_TIME  ts;		<span class="hljs-comment">// 浏览头文件 mysql_time.h 熟悉MYSQL_TIME结构体。</span>

MYSQL_BIND  bind[<span class="hljs-number">3</span>];

MYSQL_STMT  *stmt;

<span class="hljs-comment">// 可直接使用SQL语句提前创建表test_table2，也可以使用mysql_query函数来创建。</span>

create table <span class="hljs-title function_">test_table2</span> <span class="hljs-params">(date_field date, time_field time, timestamp_field timestamp)</span>;

<span class="hljs-type">char</span> query[<span class="hljs-number">1024</span>] = <span class="hljs-string">"INSERT INTO test_table2(date_field, time_field, timestamp_field) VALUES(?,?,?)"</span>;

stmt = mysql_stmt_init(mysql);

<span class="hljs-comment">// MYSQL_TIME 是一个结构体，使用typedef定义。位于mysql_time.h文件中。		</span></code></pre></div>

<p>API参考：refman-5.6-en.a4.pdf手册25.2.10. 日期和时间值的C API处理</p>
<h2><span id="duo-cha-xun-zhi-xing-de-c-api-han-shu">多查询执行的C API函数</span><a href="#duo-cha-xun-zhi-xing-de-c-api-han-shu" class="header-anchor">#</a></h2><p>一次性执行多条SQL语句，包括select、drop、update、create等。<br>如：</p>
<div class="code-wrapper"><pre><code class="hljs c">mysql_query(mysql,<span class="hljs-string">"DROP TABLE IF EXISTS test_table;\</span>
<span class="hljs-string"></span>
<span class="hljs-string">	CREATE TABLE test_table(id INT);\</span>
<span class="hljs-string"></span>
<span class="hljs-string">	INSERT INTO test_table VALUES(10);\</span>
<span class="hljs-string"></span>
<span class="hljs-string">	UPDATE test_table SET id=20 WHERE id=10;\</span>
<span class="hljs-string"></span>
<span class="hljs-string">	SELECT * FROM test_table;\</span>
<span class="hljs-string"></span>
<span class="hljs-string">	DROP TABLE test_table"</span>);</code></pre></div>
<div class="code-wrapper"><pre><code class="hljs">文档：25.2.9. 多查询执行的C API处理。中文文档只有demo框架。查阅对应英文文档refman-5.6-en.a4.pdf。关键字Multiple 23.8.17

注意：打桩函数——函数接口

if (mysql_real_connect (mysql, host_name, user_name, password,

db_name, port_num, socket_name, CLIENT_MULTI_STATEMENTS) == NULL)

CLIENT_MULTI_STATEMENTS：客户端通知Server，将要发送多个SQL语句。

mysql_field_count(mysql)：影响的行数。 如：

当select * from dept;    执行结束，提示：“5 rows in set”        表示影响了4行。

当Create一张表，    执行结束，提示：“Query OK, 0 rows affected (0.01 sec)”

当delete一行，        执行结束，提示：“Query OK, 1 row affected (0.00 sec)”

mysql_field_count函数调用后会将影响的行数保存到句柄 mysql 中。
</code></pre></div>
<p>下方是帮助文档中demo程序，它将帮助我们分析与之前掌握的API函数间的区别与联系：</p>
<div class="code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"mysql.h"</span> </span>

<span class="hljs-type">void</span> <span class="hljs-title function_">process_result_set</span><span class="hljs-params">(MYSQL *mysql, MYSQL_RES *result)</span>
{
	<span class="hljs-type">int</span> i, num;
	
	num = mysql_field_count(mysql);

	MYSQL_FIELD *fields = <span class="hljs-literal">NULL</span>;
	fields = mysql_fetch_fields(result);
	
	<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; num; i++) {
		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"%10s\t"</span>, fields[i].name);
	}
	
	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"\n"</span>);

	MYSQL_ROW row = <span class="hljs-literal">NULL</span>;
	<span class="hljs-keyword">while</span> ((row = mysql_fetch_row(result))) {
		<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; num; i++) {
			<span class="hljs-built_in">printf</span>(<span class="hljs-string">"%10s\t"</span>, row[i]);	
		}
		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"\n"</span>);
	}
}

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
	<span class="hljs-type">int</span> ret = <span class="hljs-number">0</span>, status = <span class="hljs-number">0</span>;

	MYSQL_RES *result = <span class="hljs-literal">NULL</span>;
	MYSQL *mysql = mysql_init(<span class="hljs-literal">NULL</span>);
	
	<span class="hljs-keyword">if</span> (mysql == <span class="hljs-literal">NULL</span>) {
		<span class="hljs-comment">//unsigned int mysql_errno(MYSQL *mysql) </span>
		ret = mysql_errno(mysql);
		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"mysql_init err:%d\n"</span>, ret);
		<span class="hljs-keyword">return</span> ret;
	}

	mysql = mysql_real_connect(mysql, <span class="hljs-string">"localhost"</span>, <span class="hljs-string">"root"</span>, <span class="hljs-string">"123456"</span>, <span class="hljs-string">"mydb61"</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, CLIENT_MULTI_STATEMENTS);
	
	<span class="hljs-keyword">if</span> (mysql == <span class="hljs-literal">NULL</span>) {
		ret = mysql_errno(mysql);
		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"mysql_init err:%d\n"</span>, ret);
		<span class="hljs-keyword">return</span> ret;
	}
	
	<span class="hljs-comment">/////////////////////////////以下为demo源码//////////////////////////////</span>
	
	<span class="hljs-comment">/* execute multiple statements */</span>
	status = mysql_query(mysql,<span class="hljs-string">"DROP TABLE IF EXISTS test_table;\</span>
<span class="hljs-string">	</span>
<span class="hljs-string">			CREATE TABLE test_table(id INT);\</span>
<span class="hljs-string">	</span>
<span class="hljs-string">			INSERT INTO test_table VALUES(10);\</span>
<span class="hljs-string">	</span>
<span class="hljs-string">			UPDATE test_table SET id=20 WHERE id=10;\</span>
<span class="hljs-string">	</span>
<span class="hljs-string">			SELECT * FROM test_table;"</span>);
	
			DROP TABLE test_table
	
	<span class="hljs-title function_">if</span> <span class="hljs-params">(status)</span>
	{
		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Could not execute statement(s)"</span>);
		mysql_close(mysql);
	
		<span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);
	}
	
	<span class="hljs-comment">/* process each statement result */</span>
	<span class="hljs-keyword">do</span> {
		<span class="hljs-comment">/* did current statement return data? */</span>
		result = mysql_store_result(mysql);
		<span class="hljs-keyword">if</span> (result)
		{
			<span class="hljs-comment">/* yes; process rows and free the result set */</span>
			process_result_set(mysql, result);
			mysql_free_result(result);
		}
		<span class="hljs-keyword">else</span> <span class="hljs-comment">/* no result set or error */</span>
		{
			<span class="hljs-keyword">if</span> (mysql_field_count(mysql) == <span class="hljs-number">0</span>)
			{
				<span class="hljs-built_in">printf</span>(<span class="hljs-string">"%lld rows affected\n"</span>,
				mysql_affected_rows(mysql));
			}
			<span class="hljs-keyword">else</span> <span class="hljs-comment">/* some error occurred */</span>
			{
				<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Could not retrieve result set\n"</span>);
				<span class="hljs-keyword">break</span>;
			}		
        }

		<span class="hljs-comment">/* more results? -1 = no, &gt;0 = error, 0 = yes (keep looping) */</span>
	
		<span class="hljs-keyword">if</span> ((status = mysql_next_result(mysql)) &gt; <span class="hljs-number">0</span>)
	
			<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Could not execute statement\n"</span>);
			<span class="hljs-built_in">printf</span>(<span class="hljs-string">"------------status: %d\n"</span>, status);

	} <span class="hljs-keyword">while</span> (status == <span class="hljs-number">0</span>);
	
	mysql_close(mysql);	

	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}</code></pre></div>

<p><code>process_result_set</code>函数是文档中给我们预留的打桩函数，需要我们在使用的过程中，自己实现它。</p>
<p>函数实现就是借助mysql和result两个参数打印一条sql语句查询到的结果集到屏幕。</p>
<p>可以直接使用<code>mysq_tool.c</code>中<code>if (strncmp(sqlbuf, "select", 6) == 0 || strncmp(sqlbuf, "SELECT", 6) == 0)</code>内的代码。“获取结果集”片段可以删除。“释放结果集”片段可以删除。API示例中含有该部分内容。</p>
<p>常见错误：在<code>process_result_set</code>函数实现中，不要使用<code>mysql_store_result(mysql)</code>再次获取结果集， 该result已经在API函数接口传入，直接使用参数result即可。否则会出现【段错误】。</p>
<h2><span id="mysql-zhong-de-shi-wu">MySQL中的事务</span><a href="#mysql-zhong-de-shi-wu" class="header-anchor">#</a></h2><p>测试MySQL中事务的特性。</p>
<div class="code-wrapper"><pre><code class="hljs">MySQL的事务的默认自动提交的，每执行一个sql语句都自动commit

Oracle的事务是自动打开的(以你执行的一条DML语句为标志)，但每次执行需要手动commit
</code></pre></div>
<p>在程序中设置autocommit修改MySQL事务的属性。</p>
<div class="code-wrapper"><pre><code class="hljs">set autocommit = 0 禁止自动提交

set autocommit = 1 开启自动提交MySQL中InnoDB引擎才支持事务默认自动提交机制。MYISAM引擎不支持。
</code></pre></div>
<div class="code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"mysql.h"</span> </span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> SET_TRAN	<span class="hljs-string">"SET AUTOCOMMIT=0"</span>  	<span class="hljs-comment">//手动commit	</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> UNSET_TRAN	<span class="hljs-string">"SET AUTOCOMMIT=1"</span>		<span class="hljs-comment">//自动commit </span></span>
<span class="hljs-comment">//设置事务为手动提交</span>

<span class="hljs-type">int</span> <span class="hljs-title function_">mysql_OperationTran</span><span class="hljs-params">(MYSQL *mysql)</span>  		
{
    <span class="hljs-comment">//--开启事务</span>

    <span class="hljs-type">int</span> ret = mysql_query(mysql, <span class="hljs-string">"start transaction"</span>);  
    <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"mysql_OperationTran query start err: %s\n"</span>, mysql_error(mysql));

        <span class="hljs-keyword">return</span> ret;

    }

    <span class="hljs-comment">//--设置事务为手动提交</span>
    ret = mysql_query(mysql, SET_TRAN);
    <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"mysql_OperationTran query set err: %s\n"</span>, mysql_error(mysql));

        <span class="hljs-keyword">return</span> ret;
    }
    <span class="hljs-keyword">return</span> ret;
}	

<span class="hljs-comment">//设置事务为自动提交</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">mysql_AutoTran</span><span class="hljs-params">(MYSQL *mysql)</span>
{
    <span class="hljs-comment">//--开启事务</span>
    <span class="hljs-type">int</span> ret = mysql_query(mysql, <span class="hljs-string">"start transaction"</span>);  
    <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"mysql_AutoTran query start err: %s\n"</span>, mysql_error(mysql));
        
        <span class="hljs-keyword">return</span> ret;
    }

    <span class="hljs-comment">//--设置事务为自动提交</span>
    ret = mysql_query(mysql, UNSET_TRAN);
    <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"mysql_AutoTran query set err: %s\n"</span>, mysql_error(mysql));
        
        <span class="hljs-keyword">return</span> ret;
    }

    <span class="hljs-keyword">return</span> ret;		
}

<span class="hljs-comment">//执行commit，手动提交事务</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">mysql_Commit</span><span class="hljs-params">(MYSQL *mysql)</span>
{
    <span class="hljs-type">int</span> ret = mysql_query(mysql, <span class="hljs-string">"COMMIT"</span>); 
    <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"commit err: %s\n"</span>, mysql_error(mysql));  
        <span class="hljs-keyword">return</span> ret;
    }

    <span class="hljs-keyword">return</span> ret;
}

<span class="hljs-comment">//执行rollback，回滚事务		</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">mysql_Rollback</span><span class="hljs-params">(MYSQL *mysql)</span>
{
    <span class="hljs-type">int</span> ret = mysql_query(mysql, <span class="hljs-string">"ROLLBACK"</span>);
    <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"rollback err: %s\n"</span>, mysql_error(mysql));
        <span class="hljs-keyword">return</span> ret;
    }

    <span class="hljs-keyword">return</span> ret;
} 

<span class="hljs-meta">#<span class="hljs-keyword">define</span> DROP_SAMPLE_TABLE <span class="hljs-string">"DROP TABLE IF EXISTS test_table"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> CREATE_SAMPLE_TABLE <span class="hljs-string">"CREATE TABLE test_table(col1 INT,\</span></span>
<span class="hljs-string"><span class="hljs-meta">                             col2 VARCHAR(10),\</span></span>
<span class="hljs-string"><span class="hljs-meta">                             col3 VARCHAR(10))"</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> sql01 <span class="hljs-string">"INSERT INTO test_table(col1,col2,col3) VALUES(10, 'AAA', 'A1')"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> sql02 <span class="hljs-string">"INSERT INTO test_table(col1,col2,col3) VALUES(20, 'BBB', 'B2')"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> sql03 <span class="hljs-string">"INSERT INTO test_table(col1,col2,col3) VALUES(30, 'CCC', 'C3')"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> sql04 <span class="hljs-string">"INSERT INTO test_table(col1,col2,col3) VALUES(40, 'DDD', 'D4')"</span></span>

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
    <span class="hljs-type">int</span> ret = <span class="hljs-number">0</span>;

    MYSQL *mysql = mysql_init(<span class="hljs-literal">NULL</span>);
    mysql = mysql_real_connect(mysql, <span class="hljs-string">"localhost"</span>, <span class="hljs-string">"root"</span>, <span class="hljs-string">"123456"</span>, <span class="hljs-string">"mydb2"</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">if</span> (mysql == <span class="hljs-literal">NULL</span>) {
        ret = mysql_errno(mysql);
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"func mysql_real_connect() err：%d\n"</span>, ret);

        <span class="hljs-keyword">return</span> ret;
    } 	

    <span class="hljs-built_in">printf</span>(<span class="hljs-string">" --- connect ok......\n"</span>);	

    <span class="hljs-keyword">if</span> (mysql_query(mysql, DROP_SAMPLE_TABLE)) {
        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">" DROP TABLE failed\n"</span>);
        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">" %s\n"</span>, mysql_error(mysql));
       
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);
    }

    <span class="hljs-keyword">if</span> (mysql_query(mysql, CREATE_SAMPLE_TABLE)) {
        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">" CREATE TABLE failed\n"</span>);
        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">" %s\n"</span>, mysql_error(mysql));

        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);
    }	

    ret = mysql_OperationTran(mysql); 	<span class="hljs-comment">//开启事务，并修改事务属性为手动commit </span>
    <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"mysql_OperationTran() err:%d\n"</span>, ret);

        <span class="hljs-keyword">return</span> ret;
    }

    ret = mysql_query(mysql, sql01);	<span class="hljs-comment">//向表中插入第一行数据 ‘AAA’</span>
    <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"mysql_query() err:%d\n"</span>, ret);		

        <span class="hljs-keyword">return</span> ret;
    }

    ret = mysql_query(mysql, sql02);	<span class="hljs-comment">//向表中插入第二行数据 ‘BBB’</span>
    <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"mysql_query() err:%d\n"</span>, ret);
        
        <span class="hljs-keyword">return</span> ret;
    }

    ret = mysql_Commit(mysql); 		<span class="hljs-comment">//手动提交事务</span>
    <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"mysql_Commit() err:%d\n"</span>, ret);

        <span class="hljs-keyword">return</span> ret;
    }

    ret = mysql_AutoTran(mysql); 		<span class="hljs-comment">// =再次= 修改事务属性为【自动】commit</span>
    <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"mysql_OperationTran() err:%d\n"</span>, ret);

        <span class="hljs-keyword">return</span> ret;
    }

    ret = mysql_OperationTran(mysql); 	<span class="hljs-comment">// =再次= 修改事务属性为【手动】commit</span>
    <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"mysql_OperationTran() err:%d\n"</span>, ret);

        <span class="hljs-keyword">return</span> ret;
    }

    ret = mysql_query(mysql, sql03);	<span class="hljs-comment">//向表中插入第三行数据 ‘CCC’</span>
    <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"mysql_query() err:%d\n"</span>, ret);

        <span class="hljs-keyword">return</span> ret;
    }

    ret = mysql_query(mysql, sql04);	<span class="hljs-comment">//向表中插入第四行数据 ‘DDD’</span>
    <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"mysql_query() err:%d\n"</span>, ret);
        <span class="hljs-keyword">return</span> ret;
    }

    ret = mysql_Rollback(mysql);		<span class="hljs-comment">//直接rollback操作</span>
    <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"mysql_Rollback() err:%d\n"</span>, ret);

        <span class="hljs-keyword">return</span> ret;
    }

    <span class="hljs-comment">//rollback操作是否能回退掉CCC、DDD的值，取决于事务属性。</span>
    mysql_close(mysql);

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;	

}</code></pre></div>

<p>对应参考API手册。中文：25.2.3.2.        英文：23.8.7.2</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/DataBase/">DataBase</a>
                    
                      <a class="hover-with-bg" href="/tags/Mysql/">Mysql</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/01/08/nginx%E5%AE%89%E8%A3%85/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">nginx安装</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/01/05/Mysql%E6%95%B0%E6%8D%AE%E5%BA%93/">
                        <span class="hidden-mobile">Mysql数据库</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments" lazyload>
                
                  
                
                
  <div id="lv-container" data-id="city" data-uid="MTAyMC81NTMzMi8zMTc5OQ==">
    <script type="text/javascript">
      Fluid.utils.loadComments('#lv-container', function() {
        Fluid.utils.createScript('https://cdn-city.livere.com/js/embed.dist.js');
      });
    </script>
    <noscript>Please enable JavaScript to view the comments</noscript>
  </div>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
        typing(title);
      
    })(window, document);
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
